.PHONY: help build check test test-verbose test-coverage run clean docs fmt lint all

# Color output
RED := \033[0;31m
GREEN := \033[0;32m
BLUE := \033[0;34m
NC := \033[0m # No Color

help:
	@echo "$(BLUE)ðŸ›’ cart01: Learning Rust - E-Commerce Product Structure$(NC)"
	@echo ""
	@echo "$(BLUE)Available targets:$(NC)"
	@echo "  $(GREEN)make build$(NC)           - Compile the project (no run)"
	@echo "  $(GREEN)make check$(NC)           - Check code without compiling (fast feedback)"
	@echo "  $(GREEN)make test$(NC)            - Run all tests (30+ test cases, ~100% coverage)"
	@echo "  $(GREEN)make test-verbose$(NC)    - Run tests with output (see println! in tests)"
	@echo "  $(GREEN)make run$(NC)             - Run the main binary (example usage)"
	@echo "  $(GREEN)make clean$(NC)           - Remove compiled artifacts"
	@echo "  $(GREEN)make docs$(NC)            - Generate and open documentation"
	@echo "  $(GREEN)make fmt$(NC)             - Format code with rustfmt"
	@echo "  $(GREEN)make lint$(NC)            - Check code with clippy (linter)"
	@echo "  $(GREEN)make all$(NC)             - Run: check â†’ fmt â†’ lint â†’ test â†’ build"
	@echo ""
	@echo "$(BLUE)Learning Path:$(NC)"
	@echo "  1. make check      - Verify syntax (fast)"
	@echo "  2. make test       - Run all tests (verify behavior)"
	@echo "  3. make run        - See working example"
	@echo "  4. make docs       - Read documentation (cargo docs)"
	@echo ""

# ============================================================================
# BUILD TARGETS
# ============================================================================

build: check
	@echo "$(BLUE)ðŸ“¦ Building release binary...$(NC)"
	cargo build --release
	@echo "$(GREEN)âœ… Build complete!$(NC)"

check:
	@echo "$(BLUE)ðŸ” Checking syntax and dependencies...$(NC)"
	cargo check
	@echo "$(GREEN)âœ… Check passed!$(NC)"

# ============================================================================
# TEST TARGETS (Core learning - 100% coverage target)
# ============================================================================

test:
	@echo "$(BLUE)ðŸ§ª Running tests (~100% code coverage)...$(NC)"
	cargo test --lib -- --test-threads=1 2>&1 | grep -E "(test result:|running|passed)"
	@echo ""
	@echo "$(GREEN)âœ… All tests passed!$(NC)"
	@echo ""
	@echo "$(BLUE)Test breakdown:$(NC)"
	@echo "  âœ“ Success cases     - Valid product creation"
	@echo "  âœ“ Error cases       - Zero ID, empty name, negative price, invalid date"
	@echo "  âœ“ Mutation tests    - set_name, set_price, set_description"
	@echo "  âœ“ Business logic    - is_expensive, apply_discount"
	@echo "  âœ“ Integration tests - clone, debug, serialization"
	@echo ""

test-verbose:
	@echo "$(BLUE)ðŸ§ª Running tests with output...$(NC)"
	cargo test --lib -- --nocapture --test-threads=1

test-coverage:
	@echo "$(BLUE)ðŸ“Š Test coverage report:$(NC)"
	@echo "  Run: cargo test --all"
	cargo test --all -- --nocapture 2>&1 | tail -20

# ============================================================================
# RUN TARGET (See the code in action)
# ============================================================================

run:
	@echo "$(BLUE)ðŸš€ Running example binary...$(NC)"
	cargo run --release

run-debug:
	@echo "$(BLUE)ðŸš€ Running example binary (debug)...$(NC)"
	cargo run

# ============================================================================
# CODE QUALITY TARGETS
# ============================================================================

fmt:
	@echo "$(BLUE)ðŸŽ¨ Formatting code...$(NC)"
	cargo fmt
	@echo "$(GREEN)âœ… Code formatted!$(NC)"

lint:
	@echo "$(BLUE)ðŸ”Ž Linting with clippy...$(NC)"
	cargo clippy -- -D warnings || true
	@echo "$(GREEN)âœ… Lint check complete!$(NC)"

# ============================================================================
# DOCUMENTATION TARGETS
# ============================================================================

docs:
	@echo "$(BLUE)ðŸ“š Generating documentation...$(NC)"
	cargo doc --no-deps --open 2>/dev/null || cargo doc --no-deps

# ============================================================================
# CLEANUP
# ============================================================================

clean:
	@echo "$(BLUE)ðŸ§¹ Cleaning build artifacts...$(NC)"
	cargo clean
	@echo "$(GREEN)âœ… Clean complete!$(NC)"

# ============================================================================
# COMPOSITE TARGET (Recommended workflow)
# ============================================================================

all: check fmt lint test build
	@echo ""
	@echo "$(GREEN)âœ… All checks passed!$(NC)"
	@echo ""
	@echo "$(BLUE)Next steps:$(NC)"
	@echo "  1. Review: make docs"
	@echo "  2. Run: make run"
	@echo "  3. Modify: edit src/lib.rs"
	@echo "  4. Re-run: make test"
	@echo ""
